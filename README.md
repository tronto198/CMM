# 고양이 마리오 메이커

프로젝트 소개
----------------

유저가 맵을 직접 만들고, 수정하고 그 맵을 플레이 할 수 있는 게임
유저는 마우스를 이용해 맵을 직접 만들거나 수정할 수 있고, 이는 map_list 폴더에 파일로 저장된다.
맵 제작을 시작하면 캐릭터와 직접적으로 부딪히는 블럭과, 장식물, 움직이는 몬스터를 배치하거나, bgm과 배경을 지정할 수 있다.
맵의 끝에 다다르는 것이 게임을 클리어하는 목표이지만, 맵 제작자는 각종 함정이나 트릭을 이용해 이를 방해할 수 있다.

이후 유저는 이런 형식의 맵들 중 하나를 로드해 직접 플레이어가 될 수 있다.
게임 내에서는 키보드를 이용해 캐릭터를 직접 움직이며, 제작자가 설치한 각종 함정과 트릭을 피하며 맵의 끝에 다다르는 것이 게임의 목표이다.

스크린샷
---------------
![start](./sample_images/start.JPG)
첫 실행화면

![play1](./sample_images/playing1.JPG)
실제 플레이 화면

![play3](./sample_images/playing3.png)
실제 플레이 화면 2 - 숨겨진 함정에 걸린 모습

![create1](./sample_images/create_map3.JPG)
맵 제작 화면 - 위의 플레이 화면을 제작도구로 본 모습
맵 가장자리의 화살표들은 이어진 맵들이 있다는 것을 의미한다.
왼쪽 아래의 검은 선으로 표시한 블럭들은 통과할 수 있는 블럭 트릭이다.

![create2](./sample_images/create_map4.JPG)
맵 제작 화면 2 - 숨겨져 있다가 밑에서 점프하면 나오는 블럭, 숨겨진 구름함정, 가시함정이 있는 모습

개발 동기 등
-----------------

클래스라는 것을 모르던 시절 C#을 처음 배우고 그래픽 처리를 조금 해보다가 그대로 만들어버린 프로젝트
 - 프로젝트 폴더 이름이 sample인 이유
 - 개발 기간은 C#을 배우는 것부터 시작하여 약 3주
 - 첫 프로젝트이고, 클래스라는 것도 모르던 시절에 만든 프로젝트라 코드 읽기가 너무 힘들어 수정이 불가능...

처음 만들었는데 결과에 나름 만족했고, 여러 문제점을 해결하고 개발을 지속적으로 할 수 있게 제대로 만들고 싶었다. 그래서 이후 이를 주제로 프로젝트로 몇번 시작했지만 새로운 문제들이 튀어나와 번번이 실패했다. 하지만 이것이 바탕이 되어 여러 프로젝트를 진행하는데 많은 도움이 되었다.

게임의 원판은 한국에서는 '고양이 마리오'라고 알려져 있는 게임이며 리소스 역시 이 게임에서 따왔다.


사용한 기술과 이것저것
-----------------

타이머를 이용해 일정한 시간마다 화면에 그래픽 요소를 그린다. 이때 GDIBuffer 객체를 이용해 더블버퍼링 기법을 사용한다.
- 맵에 표시되어야 할 모든 요소는 GDIBuffer의 bitmap 객체에 자신에게 정해진 그래픽을 그린다.
- 모든 요소를 GDIBuffer의 bitmap객체에 그린 이후에 GDIBuffer의 bitmap객체를 활용해 화면을 한번에 그린다.
더블 버퍼링을 사용한 그래픽 처리를 한번 예제 코드로 만들어보다가 어디까지 만들 수 있을까?로 이 프로젝트를 시작하게 되었다.

다른 타이머를 이용해 일정 시간마다 모든 요소들의 위치와 상태를 계산한다.
- 먼저 키 입력의 상황을 체크해 캐릭터가 다음 프레임에 이동할 위치를 계산한다.
- 캐릭터가 이동할 예상 위치의 좌표값에 충돌가능한 장애물이 존재하는지의 여부를 확인한다.
- 만약 장애물이 존재한다면 충돌할 요소에 따라 정해진 상호작용을 수행한다.
처음에는 그래픽 처리와 요소들의 좌표 계산을 한 타이머로 동시에 수행했지만, 개발이 진행되면서 계산량이 늘어나고 화면에 표시할 요소들이 많아지면서 밀리는 현상이 발생하였다. 이 현상을 해결하기 위해 좌표 계산과 화면에 출력하는 프로세스를 분리시켰다.

캐릭터의 이동을 자연스럽게 하기 위해 중력, 가속도, 마찰력 등을 대략적으로 적용하였다. 그런데 몹들에게는 적용하지 않았다...

맵의 구성 요소들을 어떻게 저장할지 많은 고민을 했다. 고민 끝에 저장 규칙을 설계하여 꽤나 성공적으로 저장한것 같다.
첫번째 줄에는 헤더로 맵의 갯수, 첫 시작할 맵의 번호와 좌표들을 저장하고, 두번째 줄부터는 각 맵들의 블럭들, 장식물, 몹들의 정보들을 저장한다.

소리를 재생하려 하는데 C#의 기본 기능만으로는 여러 소리를 한꺼번에 재생하지 못했다. 이에 배경음과 효과음을 동시에 들을 수 없다는 문제가 생겼는데, 이는 NAudio.dll을 이용해 해결했다. 덤으로 반복재생도 제공해주기에 소리 부분은 생각보다 손쉽게 해결했다.

프로그램을 실행시 필요한 리소스들을 모두 한꺼번에 로딩하고 필요한 인스턴스들을 생성하다 보니 지연시간이 꽤나 길었었다. 특히 소리들을 미리 로딩하는 부분이 시간을 많이 잡아먹었는데, 이를 해결하기 위해 로딩부분만은 스레드를 활용해 해결하였다.

문제점
--------------
사용된 모든 타이머가 UI 스레드에서 작동하여 컴퓨터의 속도에 따라 캐릭터의 속도가 달라진다. 이는 이후 이런 방식으로 구현한 다른 프로젝트에서는 멀티스레드로 구성하여 해결하였다.


